# Для ревьювера
 - Ссылка: https://github.com/skarachevtsev/Auth_sprint_2
 - Swagger или файл с openapi по следующим путям 
   - `/admin/api/v1/auth/swagger`
   - `/admin/api/v1/auth/openapi.json`
 - Для включения трассировки необходимо выполнить следующие действия
   - добавить в `./auth/.env` переменную `DEBUG=True` и перезапустить сервис
   - поднять jaeger с помощью команды `make dev-run c=jaeger`

 ## Как запуститьться
 - Выполнить команду `make install` (создаст сети, хранилища в докере и пустые `env` файлы)
 - Заполнить `.env` файлы в каталогах `./`, `./auth`, `./tests/functional`
 - Запустить тесты с помощью команды `make test`
 - Запустить прод с помощью команды `make run`
 - Выполнить первоначальную миграцию при необходимости можно с помощью команды `make migrate`
 - Cоздать учетную запись с правами администратора можно с помощью следующей команды
 ```
 docker exec -it auth flask create-superuser admin admin@mail.local
 ```

# Для разработчиков
## Что нужно, чтобы начать
 - docker
 - docker compose (V2, docker-compose устарел)
 - GNU Make >= 4.3
 - python3.11.1
 - установить все зависимости с помощью `make contrib`

## Как работать
1. Ознакомьтесь с возможными командами make c помощью `make help`
2. Использовать google docstings
3. Использовать одинарные кавычки для всего, кроме docstings
4. НЕ ПУШИТЬ в main ветку
5. Создайте для себя отдельный `.env` в каталоге `./development` и внесите туда все необходимые переменные для локального запуска инфраструктуры/тестирования
6. Для отдельного запуска сервиса вне контейнера можно использовать следующие команды
```
make flask command='run'
# Команда ниже запустит докер контейнер
make dev-run c=auth
```
7. Создать суперпользователя можно с помощью следующей команды
```
make flask command='create-superuser admin admin@mail.local'
```
8. Выполнить некоторые операции с flask-migrate можно с помощью указанных ниже команд. Подробнее смотрите в документации
```
make flask command='db upgrade'
make flask command='db downgrade'
```
9. Посмотреть, корректно ли работает прод можно вот так
```
  make run
  make dev-run c=rediscommander
```
10. Запустить тестирование локально можно с помощью следующих команд
   > Не забудьте поднять докер контейнеры для тестовой среды. Это можно сделать с помощью команды `make test-dev-run`
```
# Первый вариант с использованием Make
( while read line; do if test "$line"; then export "$line"; fi; done < ./development/.env; PYTHONPATH=. make test-dev )
# Второй варинат pytest напрямую. Не забудьте дождаться корректного старта всех сервисов
( while read line; do if test "$line"; then export "$line"; fi; done < ./development/.env; pytest -s -vv ; )
```

# Проектная работа 7 спринта

1. Создайте интеграцию Auth-сервиса и AsyncAPI-сервиса, используя контракт, который вы сделали в прошлом задании.
  
    При создании интеграции не забудьте учесть изящную деградацию Auth-сервиса. Как вы уже выяснили ранее, Auth сервис один из самых нагруженных, потому что в него ходят большинство сервисов сайта. И если он откажет, сайт отказать не должен. Обязательно учтите этот сценарий в интеграциях с Auth-сервисом.
2. Добавьте в Auth трасировку и подключите к Jaeger. Для этого вам нужно добавить работу с заголовком x-request-id и отправку трасировок в Jaeger.
3. Добавьте в сервис механизм ограничения количества запросов к серверу.
4. Партицируйте таблицу с пользователями. Подумайте, по каким критериям вы бы разделили её. Важно посмотреть на таблицу не только в текущем времени, но и заглядывая в некое будущее, когда в ней будут миллионы записей. Пользователи могут быть из одной страны, но из разных регионов. А еще пользователи могут использовать разные устройства для входа и иметь разные возрастные ограничения.
5. Упростите регистрацию и аутентификацию пользователей в Auth-сервисе, добавив вход через социальные сервисы. Список сервисов выбирайте исходя из целевой аудитории онлайн-кинотеатра — подумайте, какими социальными сервисами они пользуются. Например, использовать [OAuth от Github](https://docs.github.com/en/free-pro-team@latest/developers/apps/authorizing-oauth-apps){target="_blank"} — не самая удачная идея. Ваши пользователи не разработчики и вряд ли имеют аккаунт на Github. А вот добавить VK, Google, Yandex или Mail будет хорошей идеей.

    Вам не нужно делать фронтенд в этой задаче и реализовывать собственный сервер OAuth. Нужно реализовать протокол со стороны потребителя.
    
    Информация по OAuth у разных поставщиков данных: 
    
    - [Yandex](https://yandex.ru/dev/oauth/?turbo=true){target="_blank"},
    - [VK](https://vk.com/dev/access_token){target="_blank"},
    - [Google](https://developers.google.com/identity/protocols/oauth2){target="_blank"},
    - [Mail](https://api.mail.ru/docs/guides/oauth/){target="_blank"}.
    
## Дополнительное задание
    
Реализуйте возможность открепить аккаунт в соцсети от личного кабинета. 
    
Решение залейте в репозиторий текущего спринта и отправьте на ревью.
